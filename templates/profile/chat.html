{% extends "base.html" %}
{% load markdown_extras %}
{% block title %}Profiel intake{% endblock %}
{% block content %}
<section class="max-w-4xl mx-auto space-y-6">
    <header class="text-center space-y-2">
        <p class="text-sm uppercase tracking-widest text-blue-600 font-semibold">Intake</p>
        <h2 class="text-3xl font-bold text-slate-900">Bouw je leerprofiel op</h2>
        <p class="text-slate-600 text-sm">De AI stelt een paar vragen over je interesses en hoe je het liefst uitleg krijgt. Dit profiel wordt gebruikt in alle toekomstige cursussen.</p>
    </header>
    <div id="chat-scroll" class="bg-white border border-slate-100 rounded-3xl shadow-lg p-6 h-[60vh] overflow-y-auto space-y-4 scroll-smooth">
        {% for message in messages %}
            {% if message.role == 'assistant' or message.role == 'system' %}
                <div class="flex">
                    <div class="ml-0 mr-auto max-w-xl rounded-2xl bg-blue-50 px-5 py-3 text-sm text-slate-700 shadow-sm">
                        <p class="text-xs uppercase tracking-wide text-blue-600 font-semibold mb-1">{{ message.get_role_display }}</p>
                        <div class="prose prose-sm text-slate-800 max-w-none">
                            {{ message.content|render_markdown }}
                        </div>
                    </div>
                </div>
            {% elif message.role == 'user' %}
                <div class="flex">
                    <div class="mr-0 ml-auto max-w-xl rounded-2xl bg-slate-900 text-white px-5 py-3 text-sm shadow-sm">
                        <p class="text-xs uppercase tracking-wide text-slate-200 font-semibold mb-1">Jij</p>
                        <p>{{ message.content|linebreaks }}</p>
                    </div>
                </div>
            {% else %}
                <div class="flex justify-center">
                    <div class="text-xs text-slate-500 italic">{{ message.content }}</div>
                </div>
            {% endif %}
        {% empty %}
            <p class="text-center text-slate-500">Start met een korte introductie over jezelf.</p>
        {% endfor %}
    </div>
    <form method="post" class="bg-white border border-slate-100 rounded-3xl shadow-lg p-4 flex items-center gap-3" id="chat-form" data-stream-url="{% url 'profile-chat-stream' %}">
        {% csrf_token %}
        <textarea name="{{ form.message.name }}" rows="2" class="flex-1 rounded-2xl border border-slate-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>{{ form.message.value|default_if_none:'' }}</textarea>
        <button type="submit" class="inline-flex items-center gap-2 rounded-2xl bg-blue-600 text-white px-5 py-3 font-semibold text-sm hover:bg-blue-500 transition-colors disabled:opacity-60 disabled:cursor-not-allowed" id="send-button">
            <span>Verstuur</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" />
            </svg>
        </button>
    </form>
    <form method="post" class="text-center space-y-2">
        {% csrf_token %}
        <input type="hidden" name="action" value="finish"/>
        <button type="submit" id="save-button" {% if user_message_count|default:0 < 6 %}disabled{% endif %} class="inline-flex items-center gap-2 rounded-full border border-slate-300 px-5 py-2 text-sm font-semibold transition-all duration-300 transform hover:scale-105 active:scale-95 {% if user_message_count|default:0 >= 6 %}border-2 border-green-500 bg-green-500 text-white px-6 py-3 hover:bg-green-600 hover:border-green-600 hover:shadow-lg hover:scale-110 cursor-pointer{% else %}text-slate-500 cursor-not-allowed opacity-60{% endif %}">
            Opslaan & verder naar platform
        </button>
        <p class="text-xs {% if user_message_count|default:0 >= 6 %}text-green-600 font-semibold{% else %}text-slate-500{% endif %}" id="save-hint">
            {% if user_message_count|default:0 >= 6 %}
                ✓ Je hebt {{ user_message_count }} antwoorden gegeven. Je kunt nu opslaan!
            {% else %}
                Minimaal 6 antwoorden vereist. (nu: {{ user_message_count|default:0 }})
            {% endif %}
        </p>
    </form>
<div id="chat-spinner" class="fixed bottom-6 right-6 hidden items-center gap-3 rounded-2xl bg-slate-900 text-white px-5 py-3 shadow-lg">
    <svg class="h-5 w-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 00-8 8z"></path>
    </svg>
    <span class="text-sm font-semibold">AI is aan het nadenken…</span>
</div>

<script>
    const chatBox = document.getElementById('chat-scroll');
    const chatForm = document.getElementById('chat-form');
    const sendButton = document.getElementById('send-button');
    const spinner = document.getElementById('chat-spinner');
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
    let userMessageCount = {{ user_message_count|default:0 }};

    function updateSaveHint() {
        const saveHint = document.getElementById('save-hint');
        const saveButton = document.getElementById('save-button');
        
        if (saveHint) {
            if (userMessageCount >= 6) {
                saveHint.textContent = `✓ Je hebt ${userMessageCount} antwoorden gegeven. Je kunt nu opslaan!`;
                saveHint.className = 'text-xs text-green-600 font-semibold animate-pulse';
                // Remove pulse after animation
                setTimeout(() => {
                    if (saveHint) {
                        saveHint.className = 'text-xs text-green-600 font-semibold';
                    }
                }, 2000);
            } else {
                saveHint.textContent = `Minimaal 6 antwoorden vereist. (nu: ${userMessageCount})`;
                saveHint.className = 'text-xs text-slate-500';
            }
        }
        
        if (saveButton) {
            const wasReady = saveButton.classList.contains('bg-green-500');
            const isNowReady = userMessageCount >= 6;
            
            if (isNowReady) {
                // Green state - ready to save
                saveButton.className = 'inline-flex items-center gap-2 rounded-full border-2 border-green-500 bg-green-500 text-white px-6 py-3 text-sm font-semibold hover:bg-green-600 hover:border-green-600 hover:shadow-lg transition-all duration-300 transform hover:scale-110 active:scale-95 cursor-pointer';
                saveButton.disabled = false;
                
                // Add a bounce animation when it first becomes ready
                if (!wasReady) {
                    saveButton.classList.add('animate-bounce');
                    setTimeout(() => {
                        saveButton.classList.remove('animate-bounce');
                    }, 1000);
                }
            } else {
                // Gray state - not ready
                saveButton.className = 'inline-flex items-center gap-2 rounded-full border border-slate-300 px-5 py-2 text-sm font-semibold text-slate-500 hover:border-slate-400 transition-all duration-300 transform hover:scale-105 active:scale-95 cursor-not-allowed opacity-60';
                saveButton.disabled = true;
            }
        }
    }

    function scrollToBottom() {
        if (chatBox) {
            chatBox.scrollTo({top: chatBox.scrollHeight, behavior: 'smooth'});
        }
    }

    // Configure marked.js for safe markdown rendering
    if (typeof marked !== 'undefined') {
        marked.setOptions({
            breaks: true,
            gfm: true,
        });
    }

    function renderMarkdown(text) {
        if (typeof marked === 'undefined') {
            // Fallback if marked.js isn't loaded
            return text;
        }
        try {
            return marked.parse(text);
        } catch (e) {
            console.error('Markdown rendering error:', e);
            return text;
        }
    }

    function createMessageBubble(role, text, isMarkdown = false) {
        const wrapper = document.createElement('div');
        wrapper.className = 'flex';

        const bubble = document.createElement('div');
        bubble.classList.add('max-w-xl', 'rounded-2xl', 'px-5', 'py-3', 'text-sm', 'shadow-sm');

        if (role === 'user') {
            bubble.classList.add('ml-auto', 'bg-slate-900', 'text-white');
            const contentDiv = document.createElement('p');
            contentDiv.className = 'whitespace-pre-line';
            contentDiv.textContent = text;
            bubble.appendChild(contentDiv);
        } else {
            bubble.classList.add('mr-auto', 'bg-blue-50', 'text-slate-800');
            const contentDiv = document.createElement('div');
            contentDiv.className = 'prose prose-sm text-slate-800 max-w-none';
            if (isMarkdown && text) {
                contentDiv.innerHTML = renderMarkdown(text);
            } else {
                contentDiv.textContent = text || '';
            }
            bubble.appendChild(contentDiv);
        }

        wrapper.appendChild(bubble);
        return {wrapper, bubble, contentDiv: bubble.querySelector('div, p')};
    }

    async function streamMessage(event) {
        event.preventDefault();
        if (!chatForm || !chatBox) return;

        const messageField = chatForm.querySelector('textarea[name="{{ form.message.name }}"]');
        const userText = (messageField?.value || '').trim();
        if (!userText) return;

        // User bubble immediately
        const userBubble = createMessageBubble('user', userText);
        chatBox.appendChild(userBubble.wrapper);
        scrollToBottom();

        // Clear input immediately
        if (messageField) messageField.value = '';

        // Increment counter
        userMessageCount += 1;
        updateSaveHint();

        // Assistant placeholder with markdown support
        const assistantBubble = createMessageBubble('assistant', '', true);
        chatBox.appendChild(assistantBubble.wrapper);
        scrollToBottom();

        if (spinner) spinner.classList.remove('hidden');
        if (sendButton) sendButton.disabled = true;

        let accumulatedText = '';

        try {
            const response = await fetch(chatForm.dataset.streamUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken || '',
                },
                body: JSON.stringify({
                    "{{ form.message.name }}": userText,
                }),
            });

            if (!response.ok || !response.body) {
                if (assistantBubble.contentDiv) {
                    assistantBubble.contentDiv.textContent = 'Kon geen verbinding maken met de AI-service.';
                }
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const {value, done} = await reader.read();
                if (value) {
                    buffer += decoder.decode(value, {stream: true});
                    const parts = buffer.split('\n\n');
                    buffer = parts.pop() || '';
                    for (const part of parts) {
                        const line = part.trim();
                        if (!line.startsWith('data:')) continue;
                        try {
                            const payload = JSON.parse(line.replace(/^data:\s*/, ''));
                            if (payload.type === 'token') {
                                accumulatedText += payload.text;
                                if (assistantBubble.contentDiv) {
                                    assistantBubble.contentDiv.innerHTML = renderMarkdown(accumulatedText);
                                }
                                scrollToBottom();
                            } else if (payload.type === 'error') {
                                if (assistantBubble.contentDiv) {
                                    assistantBubble.contentDiv.textContent = payload.message || 'Er ging iets mis.';
                                }
                                throw new Error(payload.message || 'stream error');
                            }
                        } catch (err) {
                            console.error('Stream parse error', err);
                        }
                    }
                }
                if (done) break;
            }
        } catch (err) {
            console.error(err);
            if (assistantBubble.contentDiv) {
                assistantBubble.contentDiv.textContent = 'Er ging iets mis tijdens het streamen.';
            }
        } finally {
            if (spinner) spinner.classList.add('hidden');
            if (sendButton) sendButton.disabled = false;
            scrollToBottom();
        }
    }

    scrollToBottom();
    updateSaveHint();
    if (chatForm) {
        chatForm.addEventListener('submit', streamMessage);
        
        // Handle Enter key to send message
        const messageField = chatForm.querySelector('textarea[name="{{ form.message.name }}"]');
        if (messageField) {
            messageField.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    streamMessage(e);
                }
            });
        }
    }
</script>
</section>
{% endblock %}
