{% extends "base.html" %}
{% load static %}
{% load markdown_extras %}
{% block title %}Chat – {{ course.name }}{% endblock %}
{% block content %}
<section class="max-w-4xl mx-auto space-y-6">
    <header class="text-center space-y-2">
        <p class="text-sm uppercase tracking-widest text-blue-600 font-semibold">Live session</p>
        <h2 class="text-3xl font-bold text-slate-900">{{ course.name }}</h2>
        <p class="text-slate-600 text-sm">AI instructor conversations tailored to your curriculum.</p>
        <a href="{% static 'Dictaat_embedded_systems.pdf' %}" download class="inline-flex items-center gap-2 text-sm text-blue-600 font-semibold hover:text-blue-500">
            Download dictaat (PDF)
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 10l5 5 5-5M12 15V3m9 12v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
            </svg>
        </a>
    </header>
    <div id="chat-scroll" class="bg-white border border-slate-100 rounded-3xl shadow-lg p-6 h-[60vh] overflow-y-auto space-y-4 scroll-smooth">
        {% for message in messages %}
            {% if message.role == 'assistant' or message.role == 'system' %}
                <div class="flex">
                    <div class="ml-0 mr-auto max-w-xl rounded-2xl bg-blue-50 px-5 py-3 text-sm text-slate-700 shadow-sm">
                        <p class="text-xs uppercase tracking-wide text-blue-600 font-semibold mb-1">{{ message.get_role_display }}</p>
                        <div class="prose prose-sm text-slate-800 max-w-none whitespace-pre-line">
                            {{ message.content|render_markdown }}
                        </div>
                    </div>
                </div>
            {% elif message.role == 'user' %}
                <div class="flex">
                    <div class="mr-0 ml-auto max-w-xl rounded-2xl bg-slate-900 text-white px-5 py-3 text-sm shadow-sm">
                        <p class="text-xs uppercase tracking-wide text-slate-200 font-semibold mb-1">You</p>
                        <p class="whitespace-pre-line">{{ message.content }}</p>
                    </div>
                </div>
            {% else %}
                <div class="flex justify-center">
                    <div class="text-xs text-slate-500 italic">{{ message.content }}</div>
                </div>
            {% endif %}
        {% empty %}
            <p class="text-center text-slate-500">No messages yet. Say hi to your instructor!</p>
        {% endfor %}
    </div>
    <form method="post" class="bg-white border border-slate-100 rounded-3xl shadow-lg p-4 flex items-center gap-3" id="chat-form" data-stream-url="{% url 'chat-session-stream' pk=course.id %}">
        {% csrf_token %}
        <textarea name="{{ form.message.name }}" rows="2" class="flex-1 rounded-2xl border border-slate-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>{{ form.message.value|default_if_none:'' }}</textarea>
        <input type="hidden" name="{{ form.model_override.name }}" value="{{ form.model_override.value|default_if_none:'' }}" />
        <button type="submit" class="inline-flex items-center gap-2 rounded-2xl bg-blue-600 text-white px-5 py-3 font-semibold text-sm hover:bg-blue-500 transition-colors disabled:opacity-60 disabled:cursor-not-allowed" id="send-button">
            <span>Send</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" />
            </svg>
        </button>
    </form>
<div id="chat-spinner" class="fixed bottom-6 right-6 hidden items-center gap-3 rounded-2xl bg-slate-900 text-white px-5 py-3 shadow-lg">
    <svg class="h-5 w-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 00-8 8z"></path>
    </svg>
    <span class="text-sm font-semibold">AI is generating a response…</span>
</div>

<script>
    const chatBox = document.getElementById('chat-scroll');
    const chatForm = document.getElementById('chat-form');
    const sendButton = document.getElementById('send-button');
    const spinner = document.getElementById('chat-spinner');
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;

    function scrollToBottom() {
        if (chatBox) {
            chatBox.scrollTo({top: chatBox.scrollHeight, behavior: 'smooth'});
        }
    }

    function createMessageBubble(role, text) {
        const wrapper = document.createElement('div');
        wrapper.className = 'flex';

        const bubble = document.createElement('div');
        bubble.classList.add('max-w-xl', 'rounded-2xl', 'px-5', 'py-3', 'text-sm', 'shadow-sm', 'whitespace-pre-line');

        if (role === 'user') {
            wrapper.classList.add('flex');
            bubble.classList.add('ml-auto', 'bg-slate-900', 'text-white');
            bubble.innerText = text;
        } else {
            bubble.classList.add('mr-auto', 'bg-blue-50', 'text-slate-800');
            bubble.innerText = text || '';
        }

        wrapper.appendChild(bubble);
        return {wrapper, bubble};
    }

    async function streamMessage(event) {
        event.preventDefault();
        if (!chatForm || !chatBox) return;

        const messageField = chatForm.querySelector('textarea[name="{{ form.message.name }}"]');
        const modelField = chatForm.querySelector('input[name="{{ form.model_override.name }}"]');
        const userText = (messageField?.value || '').trim();
        if (!userText) return;

        // Add user bubble immediately
        const userBubble = createMessageBubble('user', userText);
        chatBox.appendChild(userBubble.wrapper);
        scrollToBottom();

        // Prepare assistant bubble placeholder
        const assistantBubble = createMessageBubble('assistant', '');
        chatBox.appendChild(assistantBubble.wrapper);
        scrollToBottom();

        if (spinner) spinner.classList.remove('hidden');
        if (sendButton) sendButton.disabled = true;

        try {
            const response = await fetch(chatForm.dataset.streamUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken || '',
                },
                body: JSON.stringify({
                    "{{ form.message.name }}": userText,
                    "{{ form.model_override.name }}": modelField?.value || '',
                }),
            });

            if (!response.ok || !response.body) {
                assistantBubble.bubble.innerText = 'Kon geen verbinding maken met de AI-service.';
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const {value, done} = await reader.read();
                if (value) {
                    buffer += decoder.decode(value, {stream: true});
                    const parts = buffer.split('\n\n');
                    buffer = parts.pop() || '';
                    for (const part of parts) {
                        const line = part.trim();
                        if (!line.startsWith('data:')) continue;
                        try {
                            const payload = JSON.parse(line.replace(/^data:\s*/, ''));
                            if (payload.type === 'token') {
                                assistantBubble.bubble.innerText += payload.text;
                                scrollToBottom();
                            } else if (payload.type === 'error') {
                                assistantBubble.bubble.innerText = payload.message || 'Er ging iets mis.';
                                throw new Error(payload.message || 'stream error');
                            }
                        } catch (err) {
                            console.error('Stream parse error', err);
                        }
                    }
                }
                if (done) break;
            }
        } catch (err) {
            console.error(err);
            assistantBubble.bubble.innerText = 'Er ging iets mis tijdens het streamen.';
        } finally {
            if (spinner) spinner.classList.add('hidden');
            if (sendButton) sendButton.disabled = false;
            if (messageField) messageField.value = '';
            scrollToBottom();
        }
    }

    scrollToBottom();
    if (chatForm) {
        chatForm.addEventListener('submit', streamMessage);
    }
</script>
</section>
{% endblock %}

